<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>Ú†Øª Ø®ØµÙˆØµÛŒ Ø³Ø§Ø¯Ù‡</title>
  <style>
    body {
      font-family: sans-serif;
      direction: rtl;
      background: #f9f9f9;
      padding: 20px;
    }

    #login, #chat {
      max-width: 500px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    input, button {
      padding: 10px;
      margin: 5px 0;
      width: 100%;
      font-size: 16px;
    }

    #messages {
      max-height: 300px;
      overflow-y: auto;
      margin: 10px 0;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
      background: #f0f0f0;
    }

    .message {
      margin-bottom: 10px;
      padding: 5px;
      border-radius: 10px;
    }

    .message.self {
      background: #d1f5d3;
      text-align: left;
    }

    .message.other {
      background: #e4e4e4;
      text-align: right;
    }
  </style>
</head>
<body>

<div id="login">
  <h2>ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ú†Øª</h2>
  <input type="text" id="userIdInput" placeholder="Ø¢ÛŒâ€ŒØ¯ÛŒ Ø®ÙˆØ¯Øª Ø±Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ù† (Ù…Ø«Ù„Ø§Ù‹ user1)">
  <button onclick="login()">ÙˆØ±ÙˆØ¯</button>
</div>

<div id="chat" style="display: none;">
  <h2>Ú†Øª Ø®ØµÙˆØµÛŒ</h2>
  <p>Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡: <span id="currentUserId"></span></p>
  <input type="text" id="receiverInput" placeholder="Ø¢ÛŒâ€ŒØ¯ÛŒ Ú¯ÛŒØ±Ù†Ø¯Ù‡ (Ù…Ø«Ù„Ø§Ù‹ user2)">
  <div id="messages"></div>
  <input type="text" id="messageInput" placeholder="Ù¾ÛŒØ§Ù… Ø¨Ù†ÙˆÛŒØ³...">
  <button onclick="sendMessage()">ðŸ“¨ Ø§Ø±Ø³Ø§Ù„</button>
</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  let socket;
  let currentUserId = null;

  function login() {
    const userId = document.getElementById('userIdInput').value.trim();
    if (!userId) {
      alert('Ø¢ÛŒâ€ŒØ¯ÛŒ Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø¨Ø´Ù‡!');
      return;
    }
    localStorage.setItem('userId', userId);
    startChat(userId);
  }

  function startChat(userId) {
    currentUserId = userId;
    document.getElementById('login').style.display = 'none';
    document.getElementById('chat').style.display = 'block';
    document.getElementById('currentUserId').innerText = userId;

    // Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Socket.io
    socket = io('http://localhost:3000', {
      query: { userId: userId }
    });

    socket.on('connect', () => {
      console.log('âœ… Ø§ØªØµØ§Ù„ Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯.');
    });

    socket.on('new_message', (msg) => {
      showMessage(msg);
    });
  }

  function sendMessage() {
    const receiverId = document.getElementById('receiverInput').value.trim();
    const content = document.getElementById('messageInput').value.trim();

    if (!receiverId || !content) {
      alert('Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ùˆ Ù¾ÛŒØ§Ù… Ø±Ø§ Ú©Ø§Ù…Ù„ ÙˆØ§Ø±Ø¯ Ú©Ù†.');
      return;
    }

    const msg = {
      senderId: currentUserId,
      receiverId: receiverId,
      content: content,
      timestamp: new Date().toISOString()
    };

    socket.emit('send_message', msg);
   
    document.getElementById('messageInput').value = '';
  }

  function showMessage(msg) {
    const msgDiv = document.createElement('div');
    msgDiv.classList.add('message');

    if (msg.senderId === currentUserId) {
      msgDiv.classList.add('self');
    } else {
      msgDiv.classList.add('other');
    }

    msgDiv.innerHTML = `<strong>${msg.senderId}:</strong> ${msg.content}`;
    document.getElementById('messages').appendChild(msgDiv);
    document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
  }

  // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ±ÙˆØ¯ Ù‚Ø¨Ù„ÛŒ
  window.onload = () => {
    const savedId = localStorage.getItem('userId');
    if (savedId) {
      startChat(savedId);
    }
  };
</script>

</body>
</html>
